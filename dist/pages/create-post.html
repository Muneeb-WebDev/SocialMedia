<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Post - Social Media App</title>
    <link rel="stylesheet" href="/dist/output.css" />
    <style>
      :root {
        --accent-1: #00d1ff;
        --accent-2: #7b61ff;
        --accent-3: #ff6ea3;
        --bg-1: #0b0c10;
        --card: #131418;
        --muted: #b8bac3;
      }
      html.dark body {
        background-color: #0b0c10;
        color: #e6eef8;
      }
      html.dark header {
        background-color: #0f1115;
      }
      html.dark .card {
        background-color: #0f1720;
        color: #e6eef8;
      }
      html.dark .input-field {
        background-color: #0b1220;
        color: #e6eef8;
        border-color: #1f2937;
      }
      html.dark .text-gray-900 {
        color: #e6eef8 !important;
      }
      html.dark .text-gray-700 {
        color: #cbd5e1 !important;
      }
      html.dark .text-gray-600 {
        color: #9aa6b8 !important;
      }
      html.dark .text-gray-500 {
        color: #7a8fa6 !important;
      }
      html.dark .label {
        color: #cbd5e1 !important;
      }
      html.dark .border-gray-200 {
        border-color: #1f2937 !important;
      }
      html.dark .text-blue-500 {
        color: #3b82f6 !important;
      }
      html.dark .text-green-500 {
        color: #10b981 !important;
      }
      html.dark .bg-white {
        background-color: #0f1115;
      }
      /* Emoji picker styles */
      .emoji-container {
        position: relative;
      }
      .emoji-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        background: white;
        cursor: pointer;
        font-size: 18px;
      }
      .emoji-picker {
        position: absolute;
        right: 0;
        top: 48px;
        width: 280px;
        max-height: 220px;
        overflow: auto;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        box-shadow: 0 6px 18px rgba(16, 24, 40, 0.08);
        padding: 8px;
        border-radius: 10px;
        z-index: 60;
      }
      .emoji-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 6px;
      }
      .emoji-item {
        font-size: 20px;
        padding: 6px;
        cursor: pointer;
        border-radius: 6px;
        background: transparent;
        border: none;
      }
      .emoji-item:hover {
        background: #f3f4f6;
      }
      html.dark .emoji-btn { background: #0b1220; border-color: #273141; color: #e6eef8 }
      html.dark .emoji-picker { background: #0b1220; border-color: #273141; color: #e6eef8 }
      html.dark .emoji-item:hover { background: rgba(255,255,255,0.03) }
    </style>
  </head>
  <body class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow sticky top-0 z-20">
      <div class="max-w-6xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between gap-4 flex-wrap">
          <!-- Logo -->
          <div class="flex items-center gap-3">
            <img
              src="/dist/img/logo_png-removebg-preview.png"
              class="h-10 w-12"
              alt="NextWavesDigital"
            />
            <h1
              class="text-2xl font-bold text-gray-900"
              style="
                background: linear-gradient(
                  90deg,
                  var(--accent-1),
                  var(--accent-2),
                  var(--accent-3)
                );
                -webkit-background-clip: text;
                background-clip: text;
                color: transparent;
              "
            >
              NextWavesDigital
            </h1>
          </div>

          <div id="authControls" class="hidden md:flex gap-3 items-center">
            <div id="welcomeUser" class="text-sm text-gray-600 px-4 py-2"></div>
            <a href="./index.html" class="btn-primary">Back to Home</a>
            <button
              id="logoutBtn"
              class="border border-blue-500 rounded-lg px-4 py-2 font-medium text-blue-500"
            >
              Logout
            </button>
            <button id="themeToggle" title="Toggle theme" class="btn-outline">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true"
                width="1em"
                height="1em"
                fill="currentColor"
                stroke-linecap="round"
                class="theme-toggle__classic"
                viewBox="0 0 32 32"
              >
                <clipPath id="theme-toggle__classic__cutout">
                  <path d="M0-5h30a1 1 0 0 0 9 13v24H0Z" />
                </clipPath>
                <g clip-path="url(#theme-toggle__classic__cutout)">
                  <circle cx="16" cy="16" r="9.34" />
                  <g stroke="currentColor" stroke-width="1.5">
                    <path d="M16 5.5v-4" />
                    <path d="M16 30.5v-4" />
                    <path d="M1.5 16h4" />
                    <path d="M26.5 16h4" />
                    <path d="m23.4 8.6 2.8-2.8" />
                    <path d="m5.7 26.3 2.9-2.9" />
                    <path d="m5.8 5.8 2.8 2.8" />
                    <path d="m23.4 23.4 2.9 2.9" />
                  </g>
                </g>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-2xl mx-auto px-4 py-8">
      <div class="card">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">Create a New Post</h1>

        <form id="createPostForm" class="space-y-6">
          <!-- Text Input -->
          <div class="emoji-container">
            <label for="postInput" class="label">What's on your mind?</label>
            <textarea
              id="postInput"
              rows="8"
              placeholder="Share your thoughts, ideas, or updates..."
              class="input-field"
              required
            ></textarea>
            <div style="margin-top:8px; display:flex; justify-content:flex-end;">
              <button id="emojiBtn" type="button" class="emoji-btn" title="Insert emoji">ðŸ˜Š</button>
            </div>

            <div id="emojiPicker" class="emoji-picker hidden" aria-hidden="true">
              <div id="emojiGrid" class="emoji-grid"></div>
            </div>
          
            
            
            
            <p class="text-sm text-gray-500 mt-2">
              Maximum 500 characters recommended
            </p>
          </div>

          <!-- Image URL Input -->
          <div>
            <label for="postImage" class="label">Image URL (Optional)</label>
            <input
              id="postImage"
              type="text"
              placeholder="Paste image URL here (e.g., https://example.com/image.jpg)"
              class="input-field"
            />
            <p class="text-sm text-gray-500 mt-2">
              Add a URL to an image to make your post more engaging
            </p>

            <!-- Image Preview -->
            <div id="imagePreview" class="mt-4 hidden">
              <p class="text-sm font-semibold text-gray-700 mb-2">
                Image Preview:
              </p>
              <img
                id="previewImg"
                src=""
                alt="Preview"
                class="max-w-full h-64 object-cover rounded-lg border border-gray-200"
              />
            </div>
          </div>

          <!-- Image Validation -->
          <div
            id="imageError"
            class="p-3 bg-red-100 text-red-700 rounded-lg hidden"
          >
            Invalid image URL. Please enter a valid URL.
          </div>

          <!-- Buttons -->
          <div class="flex gap-4 pt-4">
            <button type="submit" class="btn-primary flex-1">Post</button>
            <a href="./index.html" class="btn-outline flex-1 text-center">
              Cancel
            </a>
          </div>
        </form>

        <!-- Tips Section -->
        <div class="mt-8 pt-8 border-t border-gray-200">
          <h3 class="font-bold text-gray-900 mb-4">Tips for a Great Post</h3>
          <ul class="space-y-3 text-gray-700">
            <li class="flex gap-3">
              <span class="text-blue-500 font-bold">âœ“</span>
              <span>Be clear and concise with your message</span>
            </li>
            <li class="flex gap-3">
              <span class="text-blue-500 font-bold">âœ“</span>
              <span>Add images to make your post stand out</span>
            </li>
            <li class="flex gap-3">
              <span class="text-blue-500 font-bold">âœ“</span>
              <span>Make sure image URLs start with http:// or https://</span>
            </li>
            <li class="flex gap-3">
              <span class="text-blue-500 font-bold">âœ“</span>
              <span>Your posts are saved locally and visible to all users</span>
            </li>
          </ul>
        </div>
      </div>
    </main>

    <script type="module">
      import {
        load,
        save,
        isValidUrl,
        initTheme,
      } from "../javascript/utils.js";
      import { createPost } from "../javascript/posts.js";
      import { initLogout } from "../javascript/auth.js";

      // initialize theme toggle and logout helper
      initTheme("themeToggle");
      initLogout();

      const currentUser = load("currentUser");
      const welcomeEl = document.getElementById("welcomeUser");
      const form = document.getElementById("createPostForm");
      const postInput = document.getElementById("postInput");
      const imageInput = document.getElementById("postImage");
      const imagePreview = document.getElementById("imagePreview");
      const previewImg = document.getElementById("previewImg");
      const imageError = document.getElementById("imageError");
      const emojiBtn = document.getElementById("emojiBtn");
      const emojiPicker = document.getElementById("emojiPicker");
      const emojiGrid = document.getElementById("emojiGrid");

      const EMOJIS = [
        "ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜ƒ","ðŸ˜…","ðŸ˜Š","ðŸ˜","ðŸ˜˜","ðŸ˜Ž",
        "ðŸ˜¢","ðŸ˜­","ðŸ˜¡","ðŸ‘","ðŸ‘Ž","ðŸ™","ðŸ‘","ðŸ™Œ","ðŸ”¥","âœ¨",
        "ðŸŽ‰","â¤ï¸","ðŸ¤","ðŸ’¯","ðŸ¤”","ðŸ¤©","ðŸ¤¯","ðŸ¤","ðŸ’¡","ðŸŒŸ",
        "ðŸ“·","ðŸ“Œ","ðŸ””","âœ…","âŒ","ðŸ’¬","ðŸ“","ðŸ“£","ðŸ˜´","ðŸ˜‡"
      ];

      function insertAtCursor(el, text) {
        const start = el.selectionStart || 0;
        const end = el.selectionEnd || 0;
        const value = el.value || "";
        el.value = value.slice(0, start) + text + value.slice(end);
        const newPos = start + text.length;
        el.selectionStart = el.selectionEnd = newPos;
        el.focus();
      }

      function populateEmojiGrid() {
        if (!emojiGrid) return;
        emojiGrid.innerHTML = "";
        EMOJIS.forEach((em) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "emoji-item";
          btn.textContent = em;
          btn.addEventListener("click", (ev) => {
            ev.preventDefault();
            insertAtCursor(postInput, em);
            emojiPicker.classList.add("hidden");
          });
          emojiGrid.appendChild(btn);
        });
      }

      if (emojiBtn) {
        populateEmojiGrid();
        emojiBtn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          if (!emojiPicker) return;
          emojiPicker.classList.toggle("hidden");
        });

        // Close picker when clicking outside
        document.addEventListener("click", (ev) => {
          if (!emojiPicker) return;
          if (!emojiPicker.classList.contains("hidden") && !emojiPicker.contains(ev.target) && ev.target !== emojiBtn) {
            emojiPicker.classList.add("hidden");
          }
        });
      }

      // Check if user is logged in
      if (!currentUser) {
        window.location.href = "./index.html";
      }

      // Set welcome message
      if (welcomeEl && currentUser) {
        welcomeEl.textContent = `Welcome, ${currentUser.name}`;
      }

      // Image preview functionality
      imageInput.addEventListener("input", (e) => {
        const url = e.target.value.trim();

        if (!url) {
          imagePreview.classList.add("hidden");
          imageError.classList.add("hidden");
          return;
        }

        if (isValidUrl(url)) {
          previewImg.src = url;
          previewImg.onload = () => {
            imagePreview.classList.remove("hidden");
            imageError.classList.add("hidden");
          };
          previewImg.onerror = () => {
            imagePreview.classList.add("hidden");
            imageError.classList.remove("hidden");
          };
        } else {
          imagePreview.classList.add("hidden");
          imageError.classList.remove("hidden");
        }
      });

      // Form submission
      form.addEventListener("submit", (e) => {
        e.preventDefault();

        const text = postInput.value.trim();
        const imageUrl = imageInput.value.trim();

        if (!text) {
          alert("Please write something in your post");
          return;
        }

        if (imageUrl && !isValidUrl(imageUrl)) {
          alert("Please enter a valid image URL");
          return;
        }

        if (createPost(text, imageUrl)) {
          alert("Post created successfully!");
          window.location.href = "./index.html";
        }
      });

      // Initialize logout
      initLogout();
    </script>
  </body>
</html>
